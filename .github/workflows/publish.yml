name: Publish Knotty

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get Version from Tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

- name: Pack Library
      # ì—¬ê¸°ì„œ -o outì„ í•˜ë©´ 'src' ë‚´ë¶€ê°€ ì•„ë‹ˆë¼ 'ë£¨íŠ¸'ì— out í´ë”ê°€ ìƒê¹ë‹ˆë‹¤.
      run: dotnet pack src/Knotty.csproj -c Release /p:PackageVersion=${{ steps.get_version.outputs.VERSION }} -o out

    - name: Push to NuGet
      # ìœ„ì—ì„œ ë§Œë“  'ë£¨íŠ¸/out' ê²½ë¡œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
      run: dotnet nuget push out/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        # ì—¬ê¸°ë„ ë§ˆì°¬ê°€ì§€ë¡œ 'ë£¨íŠ¸/out'ì…ë‹ˆë‹¤!
        files: out/*.nupkg
        name: Release v${{ steps.get_version.outputs.VERSION }}
        body: "### ğŸ§¶ Knotty v${{ steps.get_version.outputs.VERSION }} ë¦´ë¦¬ì¦ˆ!"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
